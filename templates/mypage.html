{% extends 'base.html' %}

{% block title %}My Page{% endblock %}

{% block content %}
<div class="container">
    <!-- 사용자 정보 섹션 -->
    <section class="section">
        <h1 class="title">회원 정보</h1>
        <div class="box">
            <p><strong>닉네임</strong> <span id="nickname">User's Nickname</span></p>
            <p><strong>ID</strong> <span id="user-id">User's ID</span></p>
            <p><strong>PW</strong> <button id="edit-pw-button" class="button is-primary">수정</button></p>

            <!-- 비밀번호 수정 폼 (수정 버튼 클릭 시 표시) -->
            <div id="pw-change-form" class="mt-4" style="display: none;">
                <div class="field">
                    <label class="label">기존 PW</label>
                    <div class="control">
                        <input class="input" type="password" id="current-password" placeholder="현재 비밀번호를 입력해주세요">
                    </div>
                </div>

                <div class="field">
                    <label class="label">새로운 PW</label>
                    <div class="control">
                        <input class="input" type="password" id="new-password" placeholder="새로운 비밀번호를 입력해주세요">
                    </div>
                </div>

                <div class="field">
                    <label class="label">새로운 PW 확인</label>
                    <div class="control">
                        <input class="input" type="password" id="confirm-password" placeholder="새로운 비밀번호를 한 번 더 입력해주세요">
                    </div>
                </div>

                <button class="button is-success" id="submit-pw-change">확인</button>
            </div>
        </div>
    </section>

    <!-- 고민 목록 섹션 -->
    <section class="section">
        <h2 class="title">내 고민들</h2>
        <div id="worries-list">
            <!-- 고민 목록이 이곳에 동적으로 추가될 예정 -->
        </div>

        <!-- 로딩 스피너 -->
        <div id="loading-spinner" class="has-text-centered" style="display: none;">
            <button class="button is-loading is-primary is-outlined">Loading</button>
        </div>
    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 세션 스토리지에서 액세스 토큰 가져오기
        const token = sessionStorage.getItem('access_token');

        // 세션 스토리지에 액세스 토큰이 없는 경우
        if (!token) {
            alert('로그인이 필요합니다.');
            window.location.href = '/login';
            return;
        }
        // 세션 스토리지에 액세스 토큰이 있으면 -> 디코딩 시작
        else {
            const base64Payload = token.split('.')[1];
            const base64 = base64Payload.replace(/-/g, '+').replace(/_/g, '/');
            const decodedJWT = JSON.parse(
                decodeURIComponent(
                    window
                        .atob(base64)
                        .split('')
                        .map(function (c) {
                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                        })
                        .join('')
                )
            );

            const user_id_from_token = decodedJWT.user_id;
            const nickname_from_tokne = decodedJWT.nickname;

            document.getElementById('nickname').innerText = nickname_from_tokne;
            document.getElementById('user-id').innerText = user_id_from_token;
        }


        // 비밀번호 수정 버튼 클릭 시 폼 토글
        document.getElementById('edit-pw-button').addEventListener('click', function () {
            const pwChangeForm = document.getElementById('pw-change-form');
            pwChangeForm.style.display = pwChangeForm.style.display === 'none' ? 'block' : 'none';
        });

        // 비밀번호 변경 제출 (기능 구현 필요)
        document.getElementById('submit-pw-change').addEventListener('click', function () {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword === confirmPassword) {
                // API 요청을 통해 비밀번호 변경 처리
                fetch('/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                }).then(response => {
                    if (response.ok) {
                        alert('Password changed successfully');
                        document.getElementById('pw-change-form').style.display = 'none';
                    } else {
                        alert('Failed to change password');
                    }
                });
            } else {
                alert('New passwords do not match');
            }
        });
        let allWorries = [];
        let index = 0;
        const itemsPerPage = 10;
        let isLoading = false;

        function loadWorries() {
            if (isLoading || index >= allWorries.length) return;
            isLoading = true;
            document.getElementById('loading-spinner').style.display = 'block';

            const worriesList = document.getElementById('worries-list');
            for (let i = index; i < index + itemsPerPage && i < allWorries.length; i++) {
                const worry = allWorries[i];
                const title = worry.title || 'No title';
                const author = worry.author || 'Unknown author';
                const content = worry.content || 'No content';

                const worryItem = document.createElement('div');
                worryItem.classList.add('box');

                worryItem.innerHTML = `
                            <h2 class="subtitle">${worry.title}</h2>
                            <p>${worry.author} | 조회수: ${worry.views}</p>
                `;
                worriesList.appendChild(worryItem);
            }
            index += itemsPerPage;
            isLoading = false;
            if (index >= allWorries.length) {
                document.getElementById('loading-spinner').style.display = 'none';
            }
        }

        fetch(`/api/worries`)
            .then(response => response.json())
            .then(data => {
                allWorries = data.worries_sorted_by_date;
                loadWorries();  // 초기 고민글 로드
            })
            .catch(error => {
                console.error('Error loading worries:', error);
            });

        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
                loadWorries();
            }
        });
    });
</script>
{% endblock %}